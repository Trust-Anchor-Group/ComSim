<?xml version="1.0" encoding="utf-8"?>
<Model xmlns="http://trustanchorgroup.com/Schema/ComSim.xsd"
       xmlns:xmpp="http://trustanchorgroup.com/Schema/ComSim/XMPP.xsd"
       xmlns:iot="http://trustanchorgroup.com/Schema/ComSim/XMPPIoT.xsd"
       timeBase="StartOfSimulation"
       bucketTime="PT5S"
       timeUnit="PT1S"
       timeCycle="PT1M"
       duration="PT15S">
	<Meta>
		<Title>XMPP Devices (Sensors, Actuators &amp; Controllers)</Title>
		<Introduction>Simulates a set of XMPP Sensors, Actuators and Controllers.</Introduction>
		<Description>
			<![CDATA[ 
			Simulates 20 XMPP Sensors (10 Outdoor and 10 Indoor Temperature Sensors), 10 XMPP Actuators (Heaters) and 10 XMPP Controllers 
			(Thermostats, clients of one sensor and actuator each), controlling Heater output, based on Sensor output. Outdoor Sensor 
			Temperature Value varies randomly over time. Indoor Sensor Temperature Value varies depending on Outdoor Temperature and
			Heater output. Controllers subscribe to events, and control Heater output based on current Indoor Temperature, and a goal 
			Temperature that can be configured. Model is simplified, to illustrate communicative aspects, rather than physical properties.
			]]>
		</Description>
		<Preparation>
			<![CDATA[
			XMPP
			------

			The XMPP Client accounts are created automatically, if the broker being used supports 
			[XEP-0077: In-Band Registration](https://xmpp.org/extensions/xep-0077.html). The 
			account registration process can be protected using keys and secrets, if the broker supports
			[XEP-0348: Signing Forms](https://xmpp.org/extensions/xep-0348.html).
			]]>
		</Preparation>
		<ModelScript>
			<![CDATA[
			IntToStr2(i):=i<10?"0"+Str(i):Str(i);
			
			foreach i in 1..10 do
			(
				Global["DataOutdoorTemp"+IntToStr2(i)]:=
				{
					"Temperature":Uniform(-10,40)
				};

				Global["DataIndoorTemp"+IntToStr2(i)]:=
				{
					"Temperature":22
				};
				
				Global["DataHeater"+IntToStr2(i)]:=
				{
					"Enabled":false,
					"Temperature":22
				};
				
				Global["DataThermostat"+IntToStr2(i)]:=
				{
					"Enabled":false,
					"Goal":22
				};
			);
			]]>
		</ModelScript>
	</Meta>
	<Assemblies>
		<Assembly fileName="TAG.Simulator.Performance.dll"/>
		<Assembly fileName="TAG.Simulator.XMPP.dll"/>
		<Assembly fileName="TAG.Simulator.XMPP.IoT.dll"/>
	</Assemblies>
	<Actors>
		<Timer id="ModelTimer" N="1" period="PT1S">
			<ExternalEvent name="Elapsed" event="ModelTimerElapsed"/>
		</Timer>
		<Timer id="SampleTimer" N="1" period="PT5S">
			<ExternalEvent name="Elapsed" event="SampleTimerElapsed"/>
		</Timer>
		<xmpp:XmppActorTcp id="OutdoorTemp" domain="1451.ieeehyd.org" userName="SimOutdoorTemp" N="10" apiKey="IeeeHyderabadSimKey" secret="IeeeHyderabadSimSecret" alwaysConnected="true">
			<xmpp:PepExtension/>
			<iot:SensorServerExtension id="OutdoorTempSensor"/>
			<ExternalEvent name="OnExecuteReadoutRequest" event="ReadOutdoorTemperatureEvent" actorName="Sensor">
				<Parameter name="e"/>
			</ExternalEvent>
		</xmpp:XmppActorTcp>
		<xmpp:XmppActorTcp id="IndoorTemp" domain="1451.ieeehyd.org" userName="SimIndoorTemp" N="10" apiKey="IeeeHyderabadSimKey" secret="IeeeHyderabadSimSecret" alwaysConnected="true">
			<xmpp:PepExtension/>
			<iot:SensorServerExtension id="IndoorTempSensor"/>
			<ExternalEvent name="OnExecuteReadoutRequest" event="ReadIndoorTemperatureEvent" actorName="Sensor">
				<Parameter name="e"/>
			</ExternalEvent>
		</xmpp:XmppActorTcp>
		<xmpp:XmppActorTcp id="Heater" domain="1451.ieeehyd.org" userName="SimHeater" N="10" apiKey="IeeeHyderabadSimKey" secret="IeeeHyderabadSimSecret" alwaysConnected="true">
			<xmpp:PepExtension/>
			<iot:ControlServerExtension/>
			<iot:SensorServerExtension id="HeaterSensor"/>
			<ExternalEvent name="OnExecuteReadoutRequest" event="ReadHeaterEvent" actorName="Sensor">
				<Parameter name="e"/>
			</ExternalEvent>
		</xmpp:XmppActorTcp>
		<xmpp:XmppActorTcp id="Thermostat" domain="1451.ieeehyd.org" userName="SimThermostat" N="10" apiKey="IeeeHyderabadSimKey" secret="IeeeHyderabadSimSecret" alwaysConnected="true">
			<xmpp:PepExtension/>
			<iot:SensorClientExtension/>
			<iot:ControlClientExtension/>
			<iot:ControlServerExtension/>
			<iot:SensorServerExtension id="ThermostatSensor"/>
			<ExternalEvent name="OnExecuteReadoutRequest" event="ReadThermostatEvent" actorName="Sensor">
				<Parameter name="e"/>
			</ExternalEvent>
		</xmpp:XmppActorTcp>
	</Actors>
	<Distributions>
	</Distributions>
	<Events>
		<EventHandler id="ModelTimerElapsed" activity="Step">
			<Description>Event raised every second, to increment the simulated temperature values.</Description>
		</EventHandler>
		<EventHandler id="SampleTimerElapsed" activity="Sample">
			<Description>Event raised every five seconds, to sample and report current momentary values.</Description>
		</EventHandler>
		<EventHandler id="ReadOutdoorTemperatureEvent" activity="ReadOutdoorTemperature">
			<Description>Event raised when a client wants to read an outdoor temperature sensor.</Description>
		</EventHandler>
		<EventHandler id="ReadIndoorTemperatureEvent" activity="ReadIndoorTemperature">
			<Description>Event raised when a client wants to read an indoor temperature sensor.</Description>
		</EventHandler>
		<EventHandler id="ReadHeaterEvent" activity="ReadHeater">
			<Description>Event raised when a client wants to read a heater.</Description>
		</EventHandler>
		<EventHandler id="ReadThermostatEvent" activity="ReadThermostat">
			<Description>Event raised when a client wants to read a thermostat.</Description>
		</EventHandler>
	</Events>
	<Activities>
		<Activity id="Step">
			<Description>Calculates the next step for all simulated physical quantities.</Description>
			<Start/>
			<Eval>i:=0</Eval>
			<While>
				<Condition condition="i++&lt;10">
					<Eval>
						<![CDATA[
						OutdoorTempData:=Global["DataOutdoorTemp"+IntToStr2(i)];
						IndoorTempData:=Global["DataIndoorTemp"+IntToStr2(i)];
						HeaterData:=Global["DataHeater"+IntToStr2(i)];
						ThermostatData:=Global["DataThermostat"+IntToStr2(i)];
						]]>
					</Eval>
					<Eval>
						<![CDATA[
						OutdoorTempData.Temperature+=Uniform(-0.1,0.1);
						]]>
					</Eval>
					<Sample name="Outdoor Temperature {i}">
						<Script>OutdoorTempData.Temperature C</Script>
					</Sample>
					<Eval>
						<![CDATA[
						IndoorTempData.Temperature+=0.01*(
							(OutdoorTempData.Temperature-IndoorTempData.Temperature)+
							(HeaterData.Temperature-IndoorTempData.Temperature));
						]]>
					</Eval>
					<Sample name="Indoor Temperature {i}">
						<Script>IndoorTempData.Temperature C</Script>
					</Sample>
					<Eval>
						<![CDATA[
						HeaterData.Temperature+=0.01*(
							(IndoorTempData.Temperature-HeaterData.Temperature)+
							(HeaterData.Enabled?100-HeaterData.Temperature:0));
						]]>
					</Eval>
					<Sample name="Heater Temperature {i}">
						<Script>HeaterData.Temperature C</Script>
					</Sample>
				</Condition>
			</While>
			<Stop/>
		</Activity>
		<Activity id="Sample">
			<Description>Samples current values and reports them as momentary.</Description>
			<Start/>
			<Eval>i:=0</Eval>
			<While>
				<Condition condition="i++&lt;10">
					<Eval>
						<![CDATA[
						OutdoorTempData:=Global["DataOutdoorTemp"+IntToStr2(i)];
						IndoorTempData:=Global["DataIndoorTemp"+IntToStr2(i)];
						HeaterData:=Global["DataHeater"+IntToStr2(i)];
						ThermostatData:=Global["DataThermostat"+IntToStr2(i)];

						OutdoorTempSensor:=Global["OutdoorTempSensor"+IntToStr2(i)];
						IndoorTempSensor:=Global["IndoorTempSensor"+IntToStr2(i)];
						HeaterSensor:=Global["HeaterSensor"+IntToStr2(i)];
						ThermostatSensor:=Global["ThermostatSensor"+IntToStr2(i)];
						]]>
					</Eval>
					<iot:NewMomentaryValues sensor="OutdoorTempSensor">
						<iot:QuantityField name="Temperature" nrDecimals="1" unit="°C" type="Momentary" qos="AutomaticReadout">
							<Script>OutdoorTempData.Temperature</Script>
						</iot:QuantityField>
					</iot:NewMomentaryValues>
					<iot:NewMomentaryValues sensor="IndoorTempSensor">
						<iot:QuantityField name="Temperature" nrDecimals="1" unit="°C" type="Momentary" qos="AutomaticReadout">
							<Script>IndoorTempData.Temperature</Script>
						</iot:QuantityField>
					</iot:NewMomentaryValues>
					<iot:NewMomentaryValues sensor="HeaterSensor">
						<iot:QuantityField name="Temperature" nrDecimals="1" unit="°C" type="Momentary" qos="AutomaticReadout">
							<Script>HeaterData.Temperature</Script>
						</iot:QuantityField>
					</iot:NewMomentaryValues>
				</Condition>
			</While>
			<Stop/>
		</Activity>
		<Activity id="ReadOutdoorTemperature">
			<Description>Performs a readout of an outdoor temperature sensor.</Description>
			<Start/>
			<Count counter="ReadSensor"/>
			<Count counter="ReadOutdoorTemperature"/>
			<Eval>Data:=Global["Data"+Sensor.InstanceId]</Eval>
			<iot:ReportFields>
				<iot:QuantityField name="Temperature" nrDecimals="1" unit="°C" type="Momentary" qos="AutomaticReadout">
					<Script>Data.Temperature</Script>
				</iot:QuantityField>
			</iot:ReportFields>
			<Stop/>
		</Activity>
		<Activity id="ReadIndoorTemperature">
			<Description>Performs a readout of an indoor temperature sensor.</Description>
			<Start/>
			<Count counter="ReadSensor"/>
			<Count counter="ReadIndoorTemperature"/>
			<Eval>Data:=Global["Data"+Sensor.InstanceId]</Eval>
			<iot:ReportFields>
				<iot:QuantityField name="Temperature" nrDecimals="1" unit="°C" type="Momentary" qos="AutomaticReadout">
					<Script>Data.Temperature</Script>
				</iot:QuantityField>
			</iot:ReportFields>
			<Stop/>
		</Activity>
		<Activity id="ReadHeater">
			<Description>Performs a readout of heater.</Description>
			<Start/>
			<Count counter="ReadSensor"/>
			<Count counter="ReadHeater"/>
			<Eval>Data:=Global["Data"+Sensor.InstanceId]</Eval>
			<iot:ReportFields>
				<iot:QuantityField name="Temperature" nrDecimals="1" unit="°C" type="Momentary" qos="AutomaticReadout">
					<Script>Data.Temperature</Script>
				</iot:QuantityField>
				<iot:BooleanField name="Enabled" type="Status" qos="AutomaticReadout" writable="true">
					<Script>Data.Enabled</Script>
				</iot:BooleanField>
			</iot:ReportFields>
			<Stop/>
		</Activity>
		<Activity id="ReadThermostat">
			<Description>Performs a readout of a thermostat.</Description>
			<Start/>
			<Count counter="ReadSensor"/>
			<Count counter="ReadThermostat"/>
			<Eval>Data:=Global["Data"+Sensor.InstanceId]</Eval>
			<iot:ReportFields>
				<iot:QuantityField name="Temperature, Goal" nrDecimals="1" unit="°C" type="Status" qos="AutomaticReadout">
					<Script>Data.Goal</Script>
				</iot:QuantityField>
				<iot:BooleanField name="Enabled" type="Status" qos="AutomaticReadout" writable="true">
					<Script>Data.Enabled</Script>
				</iot:BooleanField>
			</iot:ReportFields>
			<Stop/>
		</Activity>
	</Activities>
	<Graphs>
		<CombinedSampleGraph header="System 1" title="Temperatue System 1" legend="true">
			<Source ref="Outdoor Temperature 1"/>
			<Source ref="Indoor Temperature 1"/>
			<Source ref="Heater Temperature 1"/>
		</CombinedSampleGraph>
		<CombinedSampleGraph header="System 2" title="Temperatue System 2" legend="true">
			<Source ref="Outdoor Temperature 2"/>
			<Source ref="Indoor Temperature 2"/>
			<Source ref="Heater Temperature 2"/>
		</CombinedSampleGraph>
		<CombinedSampleGraph header="System 3" title="Temperatue System 3" legend="true">
			<Source ref="Outdoor Temperature 3"/>
			<Source ref="Indoor Temperature 3"/>
			<Source ref="Heater Temperature 3"/>
		</CombinedSampleGraph>
		<CombinedSampleGraph header="System 4" title="Temperatue System 4" legend="true">
			<Source ref="Outdoor Temperature 4"/>
			<Source ref="Indoor Temperature 4"/>
			<Source ref="Heater Temperature 4"/>
		</CombinedSampleGraph>
		<CombinedSampleGraph header="System 5" title="Temperatue System 5" legend="true">
			<Source ref="Outdoor Temperature 5"/>
			<Source ref="Indoor Temperature 5"/>
			<Source ref="Heater Temperature 5"/>
		</CombinedSampleGraph>
		<CombinedSampleGraph header="System 6" title="Temperatue System 6" legend="true">
			<Source ref="Outdoor Temperature 6"/>
			<Source ref="Indoor Temperature 6"/>
			<Source ref="Heater Temperature 6"/>
		</CombinedSampleGraph>
		<CombinedSampleGraph header="System 7" title="Temperatue System 7" legend="true">
			<Source ref="Outdoor Temperature 7"/>
			<Source ref="Indoor Temperature 7"/>
			<Source ref="Heater Temperature 7"/>
		</CombinedSampleGraph>
		<CombinedSampleGraph header="System 8" title="Temperatue System 8" legend="true">
			<Source ref="Outdoor Temperature 8"/>
			<Source ref="Indoor Temperature 8"/>
			<Source ref="Heater Temperature 8"/>
		</CombinedSampleGraph>
		<CombinedSampleGraph header="System 9" title="Temperatue System 9" legend="true">
			<Source ref="Outdoor Temperature 9"/>
			<Source ref="Indoor Temperature 9"/>
			<Source ref="Heater Temperature 9"/>
		</CombinedSampleGraph>
		<CombinedSampleGraph header="System 10" title="Temperatue System 10" legend="true">
			<Source ref="Outdoor Temperature 10"/>
			<Source ref="Indoor Temperature 10"/>
			<Source ref="Heater Temperature 10"/>
		</CombinedSampleGraph>
	</Graphs>
</Model>