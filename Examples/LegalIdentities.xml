<?xml version="1.0" encoding="utf-8"?>
<Model xmlns="http://lab.tagroot.io/Schema/ComSim.xsd"
       xmlns:xmpp="http://lab.tagroot.io/Schema/ComSim/XMPP.xsd"
       xmlns:legal="http://lab.tagroot.io/Schema/ComSim/XMPPLegal.xsd"
       timeBase="StartOfSimulation"
       bucketTime="PT5S"
       timeUnit="PT1S"
       timeCycle="PT1M"
       duration="PT1M">
	<Meta>
		<Title>Legal Identities</Title>
		<Introduction>Simulates a collection of XMPP accounts that apply for legal identities.</Introduction>
		<Description>
			<![CDATA[ 
			Simulates 10 XMPP accounts, each representing a human user. Each user can apply for a legal
			identity. Users also randomly petitions each others for their identities. They also login
			to remote systems, triggering signature MFA petitions. They can also trigger custom
			signature requests.
			]]>
		</Description>
		<Preparation>
			<![CDATA[
			XMPP
			------

			The XMPP Client accounts are created automatically, if the broker being used supports 
			[XEP-0077: In-Band Registration](https://xmpp.org/extensions/xep-0077.html). The 
			account registration process can be protected using keys and secrets, if the broker supports
			[XEP-0348: Signing Forms](https://xmpp.org/extensions/xep-0348.html).
			]]>
		</Preparation>
		<ModelScript>
			<![CDATA[
			IntToStr2(i):=i<10?"0"+Str(i):Str(i);
			
			foreach i in 1..10 do
			(
				Global["User"+IntToStr2(i)]:=
				{
					"Jid":"SimLegalUser"+Str(i)+"@lab.tagroot.io",
					"LegalId":"",
					"LegalIdApproved":false,
					"IdPetitionLegalId":"",
					"IdPetitionId":"",
					"SignaturePetitionId":"",
					"SignaturePetitionLegalId":"",
					"SignaturePetitionContent":null
				};
			);
			
			GetUserData(Actor):=
			(
				Suffix:=Actor.InstanceId.Substring(9);
				i:=Num(Suffix);
				Global["User"+Suffix];
			)
			]]>
		</ModelScript>
	</Meta>
	<Assemblies>
		<Assembly fileName="TAG.Simulator.XMPP.dll"/>
		<Assembly fileName="TAG.Simulator.XMPP.Legal.dll"/>
	</Assemblies>
	<Actors>
		<xmpp:XmppActorTcp id="LegalUser" domain="lab.tagroot.io" userName="SimLegalUser" N="10"
											 apiKey="LabApiKey1" secret="LabSecret1" alwaysConnected="true">
			<legal:LegalExtension id="LegalComponent" componentAddress="legal.lab.tagroot.io"/>
			<ExternalEvent name="IdentityUpdated" event="IdentityUpdatedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="PetitionForIdentityReceived" event="PetitionForIdentityReceivedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="PetitionedIdentityResponseReceived" event="PetitionedIdentityResponseReceivedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="PetitionForSignatureReceived" event="PetitionForSignatureReceivedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="PetitionedSignatureResponseReceived" event="PetitionedSignatureResponseReceivedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="IdentityReview" event="IdentityReviewEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="ClientMessage" event="ClientMessageEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
		</xmpp:XmppActorTcp>
	</Actors>
	<Distributions>
		<Uniform id="CheckIdentity" from="0" to="10" N="5"/>
		<Uniform id="PetitionIdentity" from="0" to="10" N="5"/>
		<Uniform id="PetitionSignature" from="0" to="10" N="5"/>
	</Distributions>
	<Events>
		<StochasticEvent distribution="CheckIdentity" activity="OnCheckIdentity">
			<Description>Event to periodically check the status of a user's legal identity.</Description>
			<Description>If an approved legal identity is not found, an application is sent for one, marked as ready for approval.</Description>
			<ActorReference name="User" exclusive="true">
				<FromPopulation actor="LegalUser"/>
			</ActorReference>
		</StochasticEvent>
		<StochasticEvent distribution="PetitionIdentity" activity="OnPetitionIdentity">
			<Description>Event to periodically petition the identity of someone else.</Description>
			<ActorReference name="From" exclusive="true">
				<FromPopulation actor="LegalUser"/>
			</ActorReference>
			<ActorReference name="To" exclusive="true">
				<FromPopulation actor="LegalUser"/>
			</ActorReference>
		</StochasticEvent>
		<StochasticEvent distribution="PetitionSignature" activity="OnPetitionSignature">
			<Description>Event to periodically petition a digital signature of someone else.</Description>
			<ActorReference name="From" exclusive="true">
				<FromPopulation actor="LegalUser"/>
			</ActorReference>
			<ActorReference name="To" exclusive="true">
				<FromPopulation actor="LegalUser"/>
			</ActorReference>
		</StochasticEvent>
		<EventHandler id="IdentityUpdatedEvent" activity="OnIdentityUpdated">
			<Description>Event raised when a legal identity has been updated for a user.</Description>
		</EventHandler>
		<EventHandler id="PetitionForIdentityReceivedEvent" activity="OnPetitionForIdentityReceived">
			<Description>Event raised when another user has sent a petition to access one of the user's legal identities.</Description>
		</EventHandler>
		<EventHandler id="PetitionedIdentityResponseReceivedEvent" activity="OnPetitionedIdentityResponseReceived">
			<Description>Event raised when a response to an identity petition has been received.</Description>
		</EventHandler>
		<EventHandler id="PetitionForSignatureReceivedEvent" activity="OnPetitionForSignatureReceived">
			<Description>Event raised when another user has sent a petition for the user to perform a digital signatur.</Description>
		</EventHandler>
		<EventHandler id="PetitionedSignatureResponseReceivedEvent" activity="OnPetitionedSignatureResponseReceived">
			<Description>Event raised when a response to a digital signature petition has been received.</Description>
		</EventHandler>
		<EventHandler id="IdentityReviewEvent" activity="OnIdentityReview">
			<Description>Event raised when an Identity Application has been automatically reviewed.</Description>
		</EventHandler>
		<EventHandler id="ClientMessageEvent" activity="OnClientMessage">
			<Description>Event raised when a Client Message has been received.</Description>
		</EventHandler>
	</Events>
	<Activities>
		<Activity id="OnCheckIdentity" logStart="false" logEnd="false">
			<Description>Executed stochastically when a user checks its identity.</Description>
			<Start/>
			<Inc counter="CheckIdentity"/>
			<Eval>
				<![CDATA[
				UserData:=GetUserData(User)
				]]>
			</Eval>
			<LogInformation message="Checking legal identity.">
				<Tag key="JID" value="{UserData.Jid}"/>
			</LogInformation>
			<Conditional>
				<Condition condition="empty(UserData.LegalId)">
					<legal:GetLatestApprovedLegalId actor="User" variable="LegalId"/>
					<Conditional>
						<Condition condition="empty(LegalId)">
							<LogNotice message="Applying for new Legal ID." object="User">
								<Tag key="JID" value="{UserData.Jid}"/>
							</LogNotice>
							<legal:ApplyLegalId actor="User" variable="LegalIdObject">
								<legal:Property name="JID" value="{UserData.Jid}"/>
							</legal:ApplyLegalId>
							<Eval>
								<![CDATA[
								UserData.LegalId:=LegalIdObject.Id;
								UserData.LegalIdApproved:=false
								]]>
							</Eval>
							<legal:ReadyForApproval actor="User" legalId="{UserData.LegalId}"/>
							<LogNotice message="Waiting for approval." object="User">
								<Tag key="JID" value="{UserData.Jid}"/>
								<Tag key="LegalId" value="{UserData.LegalId}"/>
							</LogNotice>
						</Condition>
						<Otherwise>
							<Eval>
								<![CDATA[
								UserData.LegalId:=LegalId;
								UserData.LegalIdApproved:=true
								]]>
							</Eval>
							<LogInformation message="Existing Legal ID found." object="User">
								<Tag key="JID" value="{UserData.Jid}"/>
								<Tag key="LegalId" value="{UserData.LegalId}"/>
							</LogInformation>
						</Otherwise>
					</Conditional>
				</Condition>
			</Conditional>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionIdentity" logStart="false" logEnd="false">
			<Description>Executed stochastically when a user petitions the identity of another user.</Description>
			<Start/>
			<Inc counter="PetitionIdentity"/>
			<Eval>
				<![CDATA[
				FromUserData:=GetUserData(From);
				ToUserData:=GetUserData(To)
				]]>
			</Eval>
			<LogInformation message="Petitioning legal identity.">
				<Tag key="FromJid" value="{FromUserData.Jid}"/>
				<Tag key="ToJid" value="{ToUserData.Jid}"/>
			</LogInformation>
			<Conditional>
				<Condition condition="empty(FromUserData.LegalId)">
					<LogWarning message="No sender legal identity.">
						<Tag key="FromJid" value="{FromUserData.Jid}"/>
						<Tag key="ToJid" value="{ToUserData.Jid}"/>
					</LogWarning>
				</Condition>
				<Condition condition="!FromUserData.LegalIdApproved">
					<LogWarning message="Sender legal identity not approved.">
						<Tag key="FromJid" value="{FromUserData.Jid}"/>
						<Tag key="ToJid" value="{ToUserData.Jid}"/>
					</LogWarning>
				</Condition>
				<Condition condition="empty(ToUserData.LegalId)">
					<LogWarning message="No recipient legal identity.">
						<Tag key="FromJid" value="{FromUserData.Jid}"/>
						<Tag key="ToJid" value="{ToUserData.Jid}"/>
					</LogWarning>
				</Condition>
				<Condition condition="!ToUserData.LegalIdApproved">
					<LogWarning message="Recipient legal identity not approved.">
						<Tag key="FromJid" value="{FromUserData.Jid}"/>
						<Tag key="ToJid" value="{ToUserData.Jid}"/>
					</LogWarning>
				</Condition>
				<Otherwise>
					<LogNotice message="Sending petition for legal identity.">
						<Tag key="FromJid" value="{FromUserData.Jid}"/>
						<Tag key="FromLegalId" value="{FromUserData.LegalId}"/>
						<Tag key="ToJid" value="{ToUserData.Jid}"/>
						<Tag key="ToLegalId" value="{ToUserData.LegalId}"/>
					</LogNotice>
					<legal:PetitionIdentity actor="From" legalId="{ToUserData.LegalId}"
																	variable="PetitionId" purpose="Simulation"/>
					<Eval>
						<![CDATA[
						FromUserData.IdPetitionId:=PetitionId;
						FromUserData.IdPetitionLegalId:=ToUserData.LegalId;
						]]>
					</Eval>
					<LogInformation message="Identity petition sent.">
						<Tag key="FromJid" value="{FromUserData.Jid}"/>
						<Tag key="FromLegalId" value="{FromUserData.LegalId}"/>
						<Tag key="ToJid" value="{ToUserData.Jid}"/>
						<Tag key="ToLegalId" value="{ToUserData.LegalId}"/>
					</LogInformation>
				</Otherwise>
			</Conditional>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionSignature" logStart="false" logEnd="false">
			<Description>Executed stochastically when a user petitions a digital signature of another user.</Description>
			<Start/>
			<Inc counter="PetitionSignature"/>
			<Eval>
				<![CDATA[
				FromUserData:=GetUserData(From);
				ToUserData:=GetUserData(To)
				]]>
			</Eval>
			<LogInformation message="Petitioning digital signature.">
				<Tag key="FromJid" value="{FromUserData.Jid}"/>
				<Tag key="ToJid" value="{ToUserData.Jid}"/>
			</LogInformation>
			<Conditional>
				<Condition condition="empty(FromUserData.LegalId)">
					<LogWarning message="No sender legal identity.">
						<Tag key="FromJid" value="{FromUserData.Jid}"/>
						<Tag key="ToJid" value="{ToUserData.Jid}"/>
					</LogWarning>
				</Condition>
				<Condition condition="!FromUserData.LegalIdApproved">
					<LogWarning message="Sender legal identity not approved.">
						<Tag key="FromJid" value="{FromUserData.Jid}"/>
						<Tag key="ToJid" value="{ToUserData.Jid}"/>
					</LogWarning>
				</Condition>
				<Condition condition="empty(ToUserData.LegalId)">
					<LogWarning message="No recipient legal identity.">
						<Tag key="FromJid" value="{FromUserData.Jid}"/>
						<Tag key="ToJid" value="{ToUserData.Jid}"/>
					</LogWarning>
				</Condition>
				<Condition condition="!ToUserData.LegalIdApproved">
					<LogWarning message="Recipient legal identity not approved.">
						<Tag key="FromJid" value="{FromUserData.Jid}"/>
						<Tag key="ToJid" value="{ToUserData.Jid}"/>
					</LogWarning>
				</Condition>
				<Otherwise>
					<LogNotice message="Sending petition for digital signature.">
						<Tag key="FromJid" value="{FromUserData.Jid}"/>
						<Tag key="FromLegalId" value="{FromUserData.LegalId}"/>
						<Tag key="ToJid" value="{ToUserData.Jid}"/>
						<Tag key="ToLegalId" value="{ToUserData.LegalId}"/>
					</LogNotice>
					<Eval>
						<![CDATA[
						Content:=Utf8Encode(Str(NewGuid()))
						]]>
					</Eval>
					<legal:PetitionSignature actor="From" legalId="{ToUserData.LegalId}"
																	 variable="PetitionId" purpose="Simulation"
																	 content="{Content}"/>
					<Eval>
						<![CDATA[
						FromUserData.SignaturePetitionId:=PetitionId;
						FromUserData.SignaturePetitionLegalId:=ToUserData.LegalId;
						FromUserData.SignaturePetitionContent:=Content;
						]]>
					</Eval>
					<LogInformation message="Identity petition sent.">
						<Tag key="FromJid" value="{FromUserData.Jid}"/>
						<Tag key="FromLegalId" value="{FromUserData.LegalId}"/>
						<Tag key="ToJid" value="{ToUserData.Jid}"/>
						<Tag key="ToLegalId" value="{ToUserData.LegalId}"/>
					</LogInformation>
				</Otherwise>
			</Conditional>
			<Stop/>
		</Activity>
		<Activity id="OnIdentityUpdated" logStart="false" logEnd="false">
			<Description>Executed when an identity has been updated.</Description>
			<Start/>
			<Inc counter="IdentityUpdated"/>
			<Eval>
				<![CDATA[
				UserData:=GetUserData(User)
				]]>
			</Eval>
			<Conditional>
				<Condition condition="e.Identity.Id=UserData.LegalId">
					<LogInformation message="Legal Identity Updated.">
						<Tag key="JID" value="{UserData.Jid}"/>
						<Tag key="LegalId" value="{e.Identity.Id}"/>
						<Tag key="State" value="{e.Identity.State}"/>
					</LogInformation>
					<Eval>
						<![CDATA[
						UserData.LegalIdApproved:=Str(e.Identity.State)="Approved"
						]]>
					</Eval>
				</Condition>
			</Conditional>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionForIdentityReceived" logStart="false" logEnd="false">
			<Description>Executed when a petition for an identity has been received.</Description>
			<Start/>
			<Inc counter="PetitionForIdentity"/>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionedIdentityResponseReceived" logStart="false" logEnd="false">
			<Description>Executed when a response to a petition for an identity has been received.</Description>
			<Start/>
			<Inc counter="PetitionForIdentityResponse"/>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionForSignatureReceived" logStart="false" logEnd="false">
			<Description>Executed when a petition for a signature has been received.</Description>
			<Start/>
			<Inc counter="PetitionForSignature"/>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionedSignatureResponseReceived" logStart="false" logEnd="false">
			<Description>Executed when a response to a petition for a signature has been received.</Description>
			<Start/>
			<Inc counter="PetitionForSignatureResponse"/>
			<Stop/>
		</Activity>
		<Activity id="OnIdentityReview" logStart="false" logEnd="false">
			<Description>Executed when an Identity Application has been automatically reviewed.</Description>
			<Start/>
			<Inc counter="IdentityReview"/>
			<Stop/>
		</Activity>
		<Activity id="OnClientMessage" logStart="false" logEnd="false">
			<Description>Executed when a client message has been received.</Description>
			<Start/>
			<Inc counter="ClientMessage"/>
			<Stop/>
		</Activity>
	</Activities>
	<Graphs>
	</Graphs>
</Model>