<?xml version="1.0" encoding="utf-8"?>
<Model xmlns="http://lab.tagroot.io/Schema/ComSim.xsd"
       xmlns:xmpp="http://lab.tagroot.io/Schema/ComSim/XMPP.xsd"
       xmlns:legal="http://lab.tagroot.io/Schema/ComSim/XMPPLegal.xsd"
       timeBase="StartOfSimulation"
       bucketTime="PT5S"
       timeUnit="PT1S"
       timeCycle="PT1M"
       duration="PT1M">
	<Meta>
		<Title>Legal Identities</Title>
		<Introduction>Simulates a collection of XMPP accounts that apply for legal identities.</Introduction>
		<Description>
			<![CDATA[ 
			Simulates 10 XMPP accounts, each representing a human user. Each user can apply for a legal
			identity. Users also randomly petitions each others for their identities. They also login
			to remote systems, triggering signature MFA petitions. They can also trigger custom
			signature requests.
			]]>
		</Description>
		<Preparation>
			<![CDATA[
			XMPP
			------

			The XMPP Client accounts are created automatically, if the broker being used supports 
			[XEP-0077: In-Band Registration](https://xmpp.org/extensions/xep-0077.html). The 
			account registration process can be protected using keys and secrets, if the broker supports
			[XEP-0348: Signing Forms](https://xmpp.org/extensions/xep-0348.html).
			]]>
		</Preparation>
		<ModelScript>
			<![CDATA[
			IntToStr2(i):=i<10?"0"+Str(i):Str(i);
			
			foreach i in 1..10 do
			(
				Global["User"+IntToStr2(i)]:=
				{
					"Jid":"SimLegalUser"+Str(i)+"@lab.tagroot.io",
					"LegalId":""
				};
			);
			
			GetUserData(Actor):=
			(
				Suffix:=Actor.InstanceId.Substring(9);
				i:=Num(Suffix);
				Global["User"+Suffix];
			)
			]]>
		</ModelScript>
	</Meta>
	<Assemblies>
		<Assembly fileName="TAG.Simulator.XMPP.dll"/>
		<Assembly fileName="TAG.Simulator.XMPP.Legal.dll"/>
	</Assemblies>
	<Actors>
		<xmpp:XmppActorTcp id="LegalUser" domain="lab.tagroot.io" userName="SimLegalUser" N="10"
											 apiKey="LabApiKey1" secret="LabSecret1" alwaysConnected="true">
			<legal:LegalExtension id="LegalComponent" componentAddress="legal.lab.tagroot.io"/>
			<ExternalEvent name="ContractCreated" event="ContractCreatedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="ContractDeleted" event="ContractDeletedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="ContractSigned" event="ContractSignedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="ContractUpdated" event="ContractUpdatedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="IdentityUpdated" event="IdentityUpdatedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="PetitionForContractReceived" event="PetitionForContractReceivedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="PetitionedContractResponseReceived" event="PetitionedContractResponseReceivedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="PetitionForIdentityReceived" event="PetitionForIdentityReceivedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="PetitionedIdentityResponseReceived" event="PetitionedIdentityResponseReceivedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="PetitionForSignatureReceived" event="PetitionForSignatureReceivedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="PetitionedSignatureResponseReceived" event="PetitionedSignatureResponseReceivedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="PetitionForPeerReviewIDReceived" event="PetitionForPeerReviewIDReceivedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="PetitionedPeerReviewIDResponseReceived" event="PetitionedPeerReviewIDResponseReceivedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="IdentityReview" event="IdentityReviewEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="ClientMessage" event="ClientMessageEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="ContractProposalReceived" event="ContractProposalReceivedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="PetitionClientUrlReceived" event="PetitionClientUrlReceivedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
			</ExternalEvent>
		</xmpp:XmppActorTcp>
	</Actors>
	<Distributions>
		<Uniform id="CheckIdentity" from="0" to="10" N="5"/>
		<Uniform id="PetitionIdentity" from="0" to="10" N="5"/>
		<Uniform id="PetitionSignature" from="0" to="10" N="5"/>
	</Distributions>
	<Events>
		<StochasticEvent distribution="CheckIdentity" activity="OnCheckIdentity">
			<Description>Event to periodically check the status of a user's legal identity.</Description>
			<Description>If an approved legal identity is not found, an application is sent for one, marked as ready for approval.</Description>
			<ActorReference name="User" exclusive="true">
				<FromPopulation actor="LegalUser"/>
			</ActorReference>
		</StochasticEvent>
		<StochasticEvent distribution="PetitionIdentity" activity="OnPetitionIdentity">
			<Description>Event to periodically petition the identity of someone else.</Description>
			<ActorReference name="From" exclusive="true">
				<FromPopulation actor="LegalUser"/>
			</ActorReference>
			<ActorReference name="To" exclusive="true">
				<FromPopulation actor="LegalUser"/>
			</ActorReference>
		</StochasticEvent>
		<StochasticEvent distribution="PetitionSignature" activity="OnPetitionSignature">
			<Description>Event to periodically petition a digital signature of someone else.</Description>
			<ActorReference name="From" exclusive="true">
				<FromPopulation actor="LegalUser"/>
			</ActorReference>
			<ActorReference name="To" exclusive="true">
				<FromPopulation actor="LegalUser"/>
			</ActorReference>
		</StochasticEvent>
		<EventHandler id="ContractCreatedEvent" activity="OnContractCreated">
			<Description>Event raised when a contract has been created for a user.</Description>
		</EventHandler>
		<EventHandler id="ContractDeletedEvent" activity="OnContractDeleted">
			<Description>Event raised when a contract has been deleted for a user.</Description>
		</EventHandler>
		<EventHandler id="ContractSignedEvent" activity="OnContractSigned">
			<Description>Event raised when a contract has been signed for a user.</Description>
		</EventHandler>
		<EventHandler id="ContractUpdatedEvent" activity="OnContractUpdated">
			<Description>Event raised when a contract has been updated for a user.</Description>
		</EventHandler>
		<EventHandler id="IdentityUpdatedEvent" activity="OnIdentityUpdated">
			<Description>Event raised when a legal identity has been updated for a user.</Description>
		</EventHandler>
		<EventHandler id="PetitionForContractReceivedEvent" activity="OnPetitionForContractReceived">
			<Description>Event raised when another user has sent a petition to access one of the user's contracts.</Description>
		</EventHandler>
		<EventHandler id="PetitionedContractResponseReceivedEvent" activity="OnPetitionedContractResponseReceived">
			<Description>Event raised when a response to a contract petition has been received.</Description>
		</EventHandler>
		<EventHandler id="PetitionForIdentityReceivedEvent" activity="OnPetitionForIdentityReceived">
			<Description>Event raised when another user has sent a petition to access one of the user's legal identities.</Description>
		</EventHandler>
		<EventHandler id="PetitionedIdentityResponseReceivedEvent" activity="OnPetitionedIdentityResponseReceived">
			<Description>Event raised when a response to an identity petition has been received.</Description>
		</EventHandler>
		<EventHandler id="PetitionForSignatureReceivedEvent" activity="OnPetitionForSignatureReceived">
			<Description>Event raised when another user has sent a petition for the user to perform a digital signatur.</Description>
		</EventHandler>
		<EventHandler id="PetitionedSignatureResponseReceivedEvent" activity="OnPetitionedSignatureResponseReceived">
			<Description>Event raised when a response to a digital signature petition has been received.</Description>
		</EventHandler>
		<EventHandler id="PetitionForPeerReviewIDReceivedEvent" activity="OnPetitionForPeerReviewIDReceived">
			<Description>Event raised when another user has sent a petition for the user to review an identity application.</Description>
		</EventHandler>
		<EventHandler id="PetitionedPeerReviewIDResponseReceivedEvent" activity="OnPetitionedPeerReviewIDResponseReceived">
			<Description>Event raised when a response to a peer review identity petition has been received.</Description>
		</EventHandler>
		<EventHandler id="IdentityReviewEvent" activity="OnIdentityReview">
			<Description>Event raised when an Identity Application has been automatically reviewed.</Description>
		</EventHandler>
		<EventHandler id="ClientMessageEvent" activity="OnClientMessage">
			<Description>Event raised when a Client Message has been received.</Description>
		</EventHandler>
		<EventHandler id="ContractProposalReceivedEvent" activity="OnContractProposalReceived">
			<Description>Event raised when a new contract proposal has been received.</Description>
		</EventHandler>
		<EventHandler id="PetitionClientUrlReceivedEvent" activity="OnPetitionClientUrlReceived">
			<Description>Event raised when a Client URL has been sent to the client as part of a petition process. Such an URL must be opened by the client to complete the petition.</Description>
		</EventHandler>
	</Events>
	<Activities>
		<Activity id="OnCheckIdentity" logStart="false" logEnd="false">
			<Description>Executed when a user checks its identity.</Description>
			<Start/>
			<Inc counter="CheckIdentity"/>
			<Eval>
				<![CDATA[
				UserData:=GetUserData(User)
				]]>
			</Eval>
			<Conditional>
				<Condition condition="empty(UserData.LegalId)">
					<legal:GetLatestApprovedLegalId actor="User" variable="LegalId"/>
					<Conditional>
						<Condition condition="empty(LegalId)">
							<LogNotice message="Applying for new Legal ID." object="User">
								<Tag key="JID" value="{UserData.Jid}"/>
							</LogNotice>
							<legal:ApplyLegalId actor="User" variable="LegalIdObject">
								<legal:Property name="JID" value="{UserData.Jid}"/>
							</legal:ApplyLegalId>
							<Eval>
								<![CDATA[
								UserData.LegalId:=LegalIdObject.Id
								]]>
							</Eval>
							<legal:ReadyForApproval actor="User" legalId="{UserData.LegalId}"/>
							<LogNotice message="Waiting for approval." object="User">
								<Tag key="JID" value="{UserData.Jid}"/>
								<Tag key="LegalId" value="{UserData.LegalId}"/>
							</LogNotice>
						</Condition>
						<Otherwise>
							<Eval>
								<![CDATA[
								UserData.LegalId:=LegalId
								]]>
							</Eval>
							<LogInformation message="Existing Legal ID found." object="User">
								<Tag key="JID" value="{UserData.Jid}"/>
								<Tag key="LegalId" value="{UserData.LegalId}"/>
							</LogInformation>
						</Otherwise>
					</Conditional>
				</Condition>
			</Conditional>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionIdentity" logStart="false" logEnd="false">
			<Description>Executed when a user petitions the identity of another user.</Description>
			<Start/>
			<Inc counter="PetitionIdentity"/>
			<Eval>
				<![CDATA[
				FromUserData:=GetUserData(From);
				ToUserData:=GetUserData(To)
				]]>
			</Eval>
			<Conditional>
				<Condition condition="empty(FromUserData.LegalId) or empty(ToUserData.LegalId)">
					<Inc counter="UnablePetitionIdentity"/>
				</Condition>
				<Otherwise>
					<Inc counter="DoUnablePetitionIdentity"/>
				</Otherwise>
			</Conditional>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionSignature" logStart="false" logEnd="false">
			<Description>Executed when a user petitions a digital signature of another user.</Description>
			<Start/>
			<Inc counter="PetitionSignature"/>
			<Eval>
				<![CDATA[
				FromUserData:=GetUserData(From);
				ToUserData:=GetUserData(To)
				]]>
			</Eval>
			<Conditional>
				<Condition condition="empty(FromUserData.LegalId) or empty(ToUserData.LegalId)">
					<Inc counter="UnablePetitionSignature"/>
				</Condition>
				<Otherwise>
					<Inc counter="DoUnablePetitionSignature"/>
				</Otherwise>
			</Conditional>
			<Stop/>
		</Activity>
		<Activity id="OnContractCreated" logStart="false" logEnd="false">
			<Description>Executed when a contract has been created by a user.</Description>
			<Start/>
			<Inc counter="ContractCreated"/>
			<Stop/>
		</Activity>
		<Activity id="OnContractDeleted" logStart="false" logEnd="false">
			<Description>Executed when a contract has been deleted.</Description>
			<Start/>
			<Inc counter="ContractDeleted"/>
			<Stop/>
		</Activity>
		<Activity id="OnContractSigned" logStart="false" logEnd="false">
			<Description>Executed when a contract has been signed.</Description>
			<Start/>
			<Inc counter="ContractSigned"/>
			<Stop/>
		</Activity>
		<Activity id="OnContractUpdated" logStart="false" logEnd="false">
			<Description>Executed when a contract has been updated.</Description>
			<Start/>
			<Inc counter="ContractUpdated"/>
			<Stop/>
		</Activity>
		<Activity id="OnIdentityUpdated" logStart="false" logEnd="false">
			<Description>Executed when an identity has been updated.</Description>
			<Start/>
			<Inc counter="IdentityUpdated"/>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionForContractReceived" logStart="false" logEnd="false">
			<Description>Executed when a petition for a contract has been received.</Description>
			<Start/>
			<Inc counter="PetitionForContract"/>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionedContractResponseReceived" logStart="false" logEnd="false">
			<Description>Executed when a response to a petition for a contract has been received.</Description>
			<Start/>
			<Inc counter="PetitionForContractResponse"/>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionForIdentityReceived" logStart="false" logEnd="false">
			<Description>Executed when a petition for an identity has been received.</Description>
			<Start/>
			<Inc counter="PetitionForIdentity"/>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionedIdentityResponseReceived" logStart="false" logEnd="false">
			<Description>Executed when a response to a petition for an identity has been received.</Description>
			<Start/>
			<Inc counter="PetitionForIdentityResponse"/>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionForSignatureReceived" logStart="false" logEnd="false">
			<Description>Executed when a petition for a signature has been received.</Description>
			<Start/>
			<Inc counter="PetitionForSignature"/>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionedSignatureResponseReceived" logStart="false" logEnd="false">
			<Description>Executed when a response to a petition for a signature has been received.</Description>
			<Start/>
			<Inc counter="PetitionForSignatureResponse"/>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionForPeerReviewIDReceived" logStart="false" logEnd="false">
			<Description>Executed when a petition for a peer review ID has been received.</Description>
			<Start/>
			<Inc counter="PetitionForPeerReviewID"/>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionedPeerReviewIDResponseReceived" logStart="false" logEnd="false">
			<Description>Executed when a response to a petition for a peer review ID has been received.</Description>
			<Start/>
			<Inc counter="PetitionForPeerReviewIDResponse"/>
			<Stop/>
		</Activity>
		<Activity id="OnIdentityReview" logStart="false" logEnd="false">
			<Description>Executed when an Identity Application has been automatically reviewed.</Description>
			<Start/>
			<Inc counter="IdentityReview"/>
			<Stop/>
		</Activity>
		<Activity id="OnClientMessage" logStart="false" logEnd="false">
			<Description>Executed when a client message has been received.</Description>
			<Start/>
			<Inc counter="ClientMessage"/>
			<Stop/>
		</Activity>
		<Activity id="OnContractProposalReceived" logStart="false" logEnd="false">
			<Description>Executed when a new contract proposal has been received.</Description>
			<Start/>
			<Inc counter="ContractProposalReceived"/>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionClientUrlReceived" logStart="false" logEnd="false">
			<Description>Executed when a Client URL has been sent to the client as part of a petition process. Such an URL must be opened by the client to complete the petition.</Description>
			<Start/>
			<Inc counter="PetitionClientUrlReceived"/>
			<Stop/>
		</Activity>
	</Activities>
	<Graphs>
	</Graphs>
</Model>