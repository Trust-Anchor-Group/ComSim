<?xml version="1.0" encoding="utf-8"?>
<Model xmlns="http://lab.tagroot.io/Schema/ComSim.xsd"
       xmlns:web="http://lab.tagroot.io/Schema/ComSim/Web.xsd"
       xmlns:xmpp="http://lab.tagroot.io/Schema/ComSim/XMPP.xsd"
       xmlns:legal="http://lab.tagroot.io/Schema/ComSim/XMPPLegal.xsd"
       timeBase="StartOfSimulation"
       bucketTime="PT1S"
       timeUnit="PT1S"
       timeCycle="PT1M"
       duration="PT1M">
	<Meta>
		<Title>Web Sessions</Title>
		<Introduction>Simulates a collection of Web sessions that navigate password-protected pages.</Introduction>
		<Description>
			<![CDATA[ 
			Simulates 10 multi-modal Web clients, each representing a human user. Each web client 
			also has a corresponding Websocket client, to receive asynchronous events on, and an 
			XMPP client, representing a digital ID used for MFA. Each user performs actions on web 
			pages that require digital signatures (quicklogin) to authenticate the user. To maintain 
			web sessions, each user maintains its own set of cookies.
			]]>
		</Description>
		<Preparation>
			<![CDATA[
			The XMPP Client accounts are created automatically, if the broker being used supports 
			[XEP-0077: In-Band Registration](https://xmpp.org/extensions/xep-0077.html). The 
			account registration process can be protected using keys and secrets, if the broker supports
			[XEP-0348: Signing Forms](https://xmpp.org/extensions/xep-0348.html).
			]]>
		</Preparation>
		<ModelScript>
			<![CDATA[
			IntToStr2(i):=i<10?"0"+Str(i):Str(i);
			
			foreach i in 1..10 do
			(
				Global["User"+IntToStr2(i)]:=
				{
					"Index":i,
					"TabId":Str(NewGuid()),
					"Jid":"SimMfaUser"+Str(i)+"@lab.tagroot.io",
					"WebClient":null,
					"WsClient":null,
					"MfaClient":null,
					"LegalId":"",
					"LegalIdApproved":false,
					"SignaturePetitionId":"",
					"SignaturePetitionLegalId":"",
					"SignaturePetitionContent":null
				};
			);
			
			GetUserData(Actor):=
			(
				Suffix:=Actor.InstanceId.Substring(7);
				i:=Num(Suffix);
				Global["User"+Suffix];
			)
			]]>
		</ModelScript>
	</Meta>
	<Assemblies>
		<Assembly fileName="TAG.Simulator.Web.dll"/>
		<Assembly fileName="TAG.Simulator.XMPP.dll"/>
		<Assembly fileName="TAG.Simulator.XMPP.Legal.dll"/>
	</Assemblies>
	<Actors>
		<web:WebActor id="WebUser" N="10" httpVersion="1.1">
		</web:WebActor>
		<web:WebSocketActor id="Ws_User" N="10" protocol="ls" sessionActor="WebUser"
												url="wss://lab.tagroot.io/ClientEventsWS">
			<ExternalEvent name="OnConnected" event="WebSocketConnected" actorName="User">
				<Parameter name="Client"/>
			</ExternalEvent>
			<ExternalEvent name="OnTextReceived" event="WebSocketTextReceived" actorName="User">
				<Parameter name="Client"/>
				<Parameter name="Text"/>
			</ExternalEvent>
		</web:WebSocketActor>
		<xmpp:XmppActorTcp id="MfaUser" domain="lab.tagroot.io" userName="SimMfaUser" N="10"
											 apiKey="LabApiKey1" secret="LabSecret1" alwaysConnected="true">
			<legal:LegalExtension id="LegalComponent" componentAddress="legal.lab.tagroot.io"/>
			<ExternalEvent name="OnConnected" event="OnConnectedEvent" actorName="User">
				<Parameter name="Client"/>
				<Parameter name="Legal"/>
			</ExternalEvent>
			<ExternalEvent name="IdentityUpdated" event="IdentityUpdatedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
				<Parameter name="Legal"/>
			</ExternalEvent>
			<ExternalEvent name="PetitionForSignatureReceived" event="PetitionForSignatureReceivedEvent" actorName="User">
				<Parameter name="e"/>
				<Parameter name="Client"/>
				<Parameter name="Legal"/>
			</ExternalEvent>
		</xmpp:XmppActorTcp>
	</Actors>
	<Distributions>
		<Normal id="GetPostPage" μ="24" σ="6" N="100"/>
		<Normal id="ReplyToPost" μ="42" σ="6" N="10"/>
	</Distributions>
	<Events>
		<StochasticEvent distribution="GetPostPage" activity="GetUnauthenticatedPage">
			<Description>Performs a web task that does not require authentication.</Description>
			<ActorReference name="User" exclusive="true">
				<FromPopulation actor="WebUser"/>
			</ActorReference>
		</StochasticEvent>
		<StochasticEvent distribution="ReplyToPost" activity="DoQuickLogin">
			<Description>Performs a web task that requires authentication.</Description>
			<ActorReference name="User" exclusive="true">
				<FromPopulation actor="WebUser"/>
			</ActorReference>
		</StochasticEvent>
		<EventHandler id="WebSocketConnected" activity="RegisterWebSocket">
			<Description>Event raised when a web-socket connection has been established.</Description>
		</EventHandler>
		<EventHandler id="WebSocketTextReceived" activity="CheckIncomingWebSocketText">
			<Description>Event raised when a text message has been received over a web-socket connection.</Description>
		</EventHandler>
		<EventHandler id="OnConnectedEvent" activity="OnConnected">
			<Description>Event raised when the XMPP connection state changes to connected for a user.</Description>
		</EventHandler>
		<EventHandler id="IdentityUpdatedEvent" activity="OnIdentityUpdated">
			<Description>Event raised when a legal identity has been updated for a user.</Description>
		</EventHandler>
		<EventHandler id="PetitionForSignatureReceivedEvent" activity="OnPetitionForSignatureReceived">
			<Description>Event raised when another user has sent a petition for the user to perform a digital signatur.</Description>
		</EventHandler>
	</Events>
	<Activities>
		<Activity id="RegisterWebSocket" logStart="false" logEnd="false">
			<Description>Registers the Tab ID for the web actor with the web socket.</Description>
			<Start/>
			<Eval>
				<![CDATA[
				UserData:=GetUserData(User);
				UserData.WsClient:=User;
				]]>
			</Eval>
			<LogInformation message="Registering Tab." actor="User{UserData.Index}">
				<Tag key="TabID" value="{UserData.TabId}"/>
			</LogInformation>
			<web:SendSocket actor="User">
				<web:Payload>
					<Script>
						<![CDATA[
						{
							"cmd": "Register",
							"tabId": UserData.TabId,
							"location": "https://lab.tagroot.io/Community/Post/Page_retrieved_from_simulation"
						}
						]]>
					</Script>
				</web:Payload>
			</web:SendSocket>
			<Stop/>
		</Activity>
		<Activity id="GetUnauthenticatedPage" logStart="false" logEnd="false">
			<Description>Gets a web page that does not require the user to login.</Description>
			<Start/>
			<Eval>
				<![CDATA[
				UserData:=GetUserData(User);
				UserData.WebClient:=User;
				]]>
			</Eval>
			<LogInformation message="Getting page." actor="User{UserData.Index}"/>
			<web:GET actor="User"
							 url="https://lab.tagroot.io/Community/Post/Page_retrieved_from_simulation"
							 timeout="PT10S"
							 variable="Response">
				<web:Header name="Accept" value="text/html"/>
			</web:GET>
			<Sample name="GET">
				<Script>UserData.Index</Script>
			</Sample>
			<Stop/>
		</Activity>
		<Activity id="DoQuickLogin" logStart="false" logEnd="false">
			<Description>Starts a Quick-Login procedure to login to the page.</Description>
			<Start/>
			<Eval>
				<![CDATA[
				UserData:=GetUserData(User);
				UserData.WebClient:=User;
				]]>
			</Eval>
			<LogInformation message="Initiating QuickLogin." actor="User{UserData.Index}">
				<Tag key="TabID" value="{UserData.TabId}"/>
				<Tag key="LegalId" value="{UserData.LegalId}"/>
			</LogInformation>
			<web:GET actor="User"
							 url="https://lab.tagroot.io/Community/Login.md"
							 timeout="PT10S"
							 variable="LoginPage">
				<web:Header name="Accept" value="text/html"/>
			</web:GET>
			<Sample name="GET">
				<Script>UserData.Index</Script>
			</Sample>
			<Eval>
				<![CDATA[
				if !(LoginPage.HtmlText like ".*\\<div(\\s+id=\"quickLoginCode\"|\\s+data-mode=\"[^\"]*\"|\\s+data-serviceId=\"(?'ServiceId'[^\"]*)\"|\\s+data-purpose=\"(?'Purpose'[^\"]*)\")*(><\/div>|\/>).*") then error("Unexpected response received. Unable to start QuickLogin");
				]]>
			</Eval>
			<web:POST actor="User"
							url="https://lab.tagroot.io/QuickLogin"
							timeout="PT10S"
							variable="Response">
				<web:Header name="Accept" value="application/json"/>
				<web:Payload>
					<Script>
						<![CDATA[
						{
							"serviceId": ServiceId,
							"tab": UserData.TabId,
							"mode": "image",
							"purpose": Purpose
						}						
						]]>
					</Script>
				</web:Payload>
			</web:POST>
			<Sample name="POST">
				<Script>UserData.Index</Script>
			</Sample>
			<Conditional>
				<Condition condition="exists(UserData.MfaClient) and UserData.LegalIdApproved">
					<Eval>
						<![CDATA[
							Url:=Response.signUrl;
							s:=After(Url,":");
							Domain:=Before(s,",");
							Key:=After(s,",");
						]]>
					</Eval>
					<xmpp:Request actor="UserData.MfaClient" responseVariable="Response"
												to="{Domain}" type="Set">
						<Script>
							<![CDATA[
							<ql xmlns='https://tagroot.io/schema/Signature' 
								key=(Key) 
								legalId=(UserData.LegalId) />
							]]>
						</Script>
					</xmpp:Request>
				</Condition>
				<Otherwise>
					<LogError message="User has no approved Legal ID, as required for QuickLogin." object="{User}"/>
				</Otherwise>
			</Conditional>
			<Stop/>
		</Activity>
		<Activity id="CheckIncomingWebSocketText" logStart="false" logEnd="false">
			<Description>Executed when a message has been received that needs to be checked for a successful Quick Login.</Description>
			<Start/>
			<Eval>
				<![CDATA[
				Event:=JsonDecode(Text);
				UserData:=GetUserData(User);
				]]>
			</Eval>
			<Conditional>
				<Condition condition="Event.type='SignatureReceivedBE'">
					<LogInformation message="Replying to post." actor="User{UserData.Index}">
						<Tag key="TabID" value="{UserData.TabId}"/>
						<Tag key="LegalId" value="{UserData.LegalId}"/>
					</LogInformation>
					<web:POST actor="UserData.WebClient"
										url="https://lab.tagroot.io/Community/Api/ReplyToPost.ws"
										timeout="PT10S"
										variable="Response">
						<web:Header name="Accept" value="application/json"/>
						<web:Payload>
							<Script>
								<![CDATA[
								{
									"link": "Page_retrieved_from_simulation",
									"message": "Reply generated by [ComSim](https://github.com/Trust-Anchor-Group/ComSim) "+
										"[simulation](https://github.com/Trust-Anchor-Group/ComSim/blob/master/Examples/WebSessions.xml)."
								}
								]]>
							</Script>
						</web:Payload>
					</web:POST>
					<Sample name="POST">
						<Script>UserData.Index</Script>
					</Sample>
				</Condition>
			</Conditional>
			<Stop/>
		</Activity>
		<Activity id="OnConnected" logStart="false" logEnd="false">
			<Description>Executed when the XMPP connection state changes to connected for a user.</Description>
			<Start/>
			<Eval>
				<![CDATA[
				UserData:=GetUserData(User);
				UserData.MfaClient:=User;
				]]>
			</Eval>
			<LogInformation message="Checking legal identity.">
				<Tag key="JID" value="{UserData.Jid}"/>
			</LogInformation>
			<Conditional>
				<Condition condition="empty(UserData.LegalId)">
					<legal:GetLatestApprovedLegalId actor="User" variable="LegalId"/>
					<Conditional>
						<Condition condition="empty(LegalId)">
							<LogNotice message="Applying for new Legal ID." object="User">
								<Tag key="JID" value="{UserData.Jid}"/>
							</LogNotice>
							<legal:ApplyLegalId actor="User" variable="LegalIdObject">
								<legal:Property name="JID" value="{UserData.Jid}"/>
							</legal:ApplyLegalId>
							<Eval>
								<![CDATA[
								UserData.LegalId:=LegalIdObject.Id;
								UserData.LegalIdApproved:=false
								]]>
							</Eval>
							<legal:ReadyForApproval actor="User" legalId="{UserData.LegalId}"/>
							<LogNotice message="Waiting for approval." object="User">
								<Tag key="JID" value="{UserData.Jid}"/>
								<Tag key="LegalId" value="{UserData.LegalId}"/>
							</LogNotice>
						</Condition>
						<Otherwise>
							<Eval>
								<![CDATA[
								UserData.LegalId:=LegalId;
								UserData.LegalIdApproved:=true;
								]]>
							</Eval>
							<LogInformation message="Existing Legal ID found." object="User">
								<Tag key="JID" value="{UserData.Jid}"/>
								<Tag key="LegalId" value="{UserData.LegalId}"/>
							</LogInformation>
						</Otherwise>
					</Conditional>
				</Condition>
			</Conditional>
			<Stop/>
		</Activity>
		<Activity id="OnIdentityUpdated" logStart="false" logEnd="false">
			<Description>Executed when an identity has been updated.</Description>
			<Start/>
			<Eval>
				<![CDATA[
				UserData:=GetUserData(User)
				]]>
			</Eval>
			<Conditional>
				<Condition condition="e.Identity.Id=UserData.LegalId">
					<LogInformation message="Legal Identity Updated.">
						<Tag key="JID" value="{UserData.Jid}"/>
						<Tag key="LegalId" value="{e.Identity.Id}"/>
						<Tag key="State" value="{e.Identity.State}"/>
					</LogInformation>
					<Eval>
						<![CDATA[
						UserData.LegalIdApproved:=e.Identity.State.ToString()="Approved";
						]]>
					</Eval>
				</Condition>
			</Conditional>
			<Stop/>
		</Activity>
		<Activity id="OnPetitionForSignatureReceived" logStart="false" logEnd="false">
			<Description>Executed when a petition for a signature has been received.</Description>
			<Start/>
			<legal:SignaturePetitionResponse actor="User" variable="e" response="true"/>
			<Stop/>
		</Activity>
	</Activities>
	<Graphs>
		<CustomGraph for="GET">
			<![CDATA[
      [Labels,Counts]:=Histogram(GET,1,10,10);
      G:=VerticalBars(str(1..10),Counts);
      G.LabelX:="User";
      G.LabelY:="Number of GETs";
      G.Title:="Distribution of numbers GET calls";
      G
      ]]>
		</CustomGraph>
		<CustomGraph for="POST">
			<![CDATA[
      [Labels,Counts]:=Histogram(POST,1,10,10);
      G:=VerticalBars(str(1..10),Counts);
      G.LabelX:="User";
      G.LabelY:="Number of POSTs";
      G.Title:="Distribution of numbers POST calls";
      G
      ]]>
		</CustomGraph>
	</Graphs>
</Model>